<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SINTECH :: FASE 06 - DESPERTAR (HARDMODE)</title>

  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#010a12;
      --panel: rgba(3, 18, 28, 0.88);
      --border: rgba(0, 240, 255, 0.22);
      --line: rgba(0, 240, 255, 0.08);
      --cyan:#00f0ff;
      --green:#00ff41;
      --yellow:#fcee0a;
      --red:#ff003c;
      --muted:#8aa3ad;
      --text:#e6fbff;

      --void:#9d00ff;
      --orange:#ff9900;

      --btn:#071c2b;
      --btn2:#061521;
      --shadow: rgba(0,240,255,0.12);
    }

    *{box-sizing:border-box; margin:0; padding:0;}
    body{
      font-family: 'Share Tech Mono', monospace;
      background:
        radial-gradient(circle at 20% 10%, rgba(0,240,255,0.08), transparent 35%),
        radial-gradient(circle at 70% 30%, rgba(157,0,255,0.07), transparent 40%),
        radial-gradient(circle at 50% 90%, rgba(255,0,60,0.05), transparent 45%),
        #01060b;
      color: var(--text);
      height:100vh;
      overflow:hidden;
      display:grid;
      grid-template-rows: 64px 1fr 210px;
    }

    /* Scanlines */
    body:before{
      content:"";
      position:fixed; inset:0;
      background: linear-gradient(rgba(0,240,255,0.03) 50%, transparent 50%);
      background-size: 100% 4px;
      pointer-events:none;
      z-index: 2;
      opacity: 0.6;
    }

    header{
      z-index: 5;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(to bottom, rgba(0,0,0,0.35), rgba(0,0,0,0.15));
      padding: 0 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }
    .title{
      display:flex; flex-direction:column;
      line-height:1.05;
    }
    .title .h1{
      font-size: 18px;
      letter-spacing: 2px;
      color: var(--cyan);
      text-shadow: 0 0 18px rgba(0,240,255,0.35);
    }
    .title .sub{
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 2px;
    }

    .hud{
      display:flex;
      gap: 14px;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .hud b{ color: var(--text); font-weight: 700; }
    .pill{
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.25);
      padding: 8px 10px;
      box-shadow: 0 0 22px rgba(0,240,255,0.06);
      min-width: 140px;
    }
    .pill .v{
      color: var(--cyan);
      font-weight: 700;
    }

    #main{
      position:relative;
      z-index: 4;
      display:grid;
      grid-template-columns: 340px 1fr 340px;
      gap: 12px;
      padding: 12px;
      overflow:hidden;
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: 0 0 30px var(--shadow);
      padding: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
      min-height: 0;
    }

    .panelTitle{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(0,240,255,0.12);
      gap: 10px;
    }
    .panelTitle h2{
      font-size: 13px;
      letter-spacing: 2px;
      color: var(--cyan);
      text-transform: uppercase;
    }
    .panelTitle .tag{
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .statRow{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      font-size: 14px;
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.25);
    }
    .statRow .k{ color: var(--muted); }
    .statRow .val{ font-weight: 700; }
    .val.ok{ color: var(--green); }
    .val.warn{ color: var(--yellow); }
    .val.crit{ color: var(--red); text-shadow: 0 0 10px rgba(255,0,60,0.35); }

    .bars{
      display:grid;
      gap: 10px;
    }
    .barBlock{
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.25);
      padding: 10px;
    }
    .barHeader{
      display:flex;
      justify-content:space-between;
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 8px;
    }
    .bar{
      height: 10px;
      background: rgba(255,255,255,0.06);
      overflow:hidden;
      border: 1px solid rgba(0,240,255,0.10);
    }
    .fill{
      height: 100%;
      width: 0%;
      transition: width 250ms linear;
    }

    .graphs{
      display:grid;
      grid-template-rows: 1fr 1fr;
      gap: 10px;
      min-height: 0;
    }
    .graphBox{
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.32);
      position: relative;
      overflow:hidden;
      min-height: 0;
    }
    .graphLabel{
      position:absolute;
      top: 8px; left: 10px;
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 2px;
      text-transform: uppercase;
      z-index: 2;
      background: rgba(0,0,0,0.35);
      padding: 4px 8px;
      border: 1px solid rgba(255,255,255,0.06);
    }
    canvas{ display:block; width:100%; height:100%; }

    /* Center: camera + dialogue */
    #center{
      position: relative;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.35);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
      min-height: 0;
    }
    #camera{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      filter: blur(18px) grayscale(100%) brightness(0.9);
      transition: filter 4s ease;
      background:
        radial-gradient(circle at 30% 40%, rgba(0,240,255,0.10), transparent 40%),
        radial-gradient(circle at 70% 30%, rgba(157,0,255,0.08), transparent 45%),
        radial-gradient(circle at 50% 60%, rgba(255,0,60,0.06), transparent 50%),
        linear-gradient(to bottom, rgba(255,255,255,0.03), transparent 55%),
        #000;
    }
    #silhouette{
      width: 220px;
      height: 320px;
      border-radius: 48% 48% 42% 42%;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(0,240,255,0.18);
      box-shadow: 0 0 55px rgba(0,240,255,0.10);
      opacity: 0;
      transform: scale(0.98);
      transition: opacity 2.2s ease, transform 2.2s ease;
      position: relative;
    }
    .eye{
      position:absolute;
      top: 44%;
      width: 46px;
      height: 10px;
      border-top: 2px solid rgba(0,240,255,0.85);
      left: 25%;
      filter: drop-shadow(0 0 8px rgba(0,240,255,0.25));
      transition: all 220ms ease;
    }
    .eye.r{ left:auto; right: 25%; }
    .eye.open{
      height: 24px;
      border-top: none;
      background: rgba(0,240,255,0.92);
      border-radius: 50%;
      box-shadow: 0 0 22px rgba(0,240,255,0.55);
    }

    #dialogue{
      position:relative;
      z-index: 3;
      border-top: 1px solid rgba(0,240,255,0.15);
      background: rgba(0,0,0,0.72);
      padding: 16px 16px 14px;
      min-height: 130px;
    }
    #speaker{
      color: var(--cyan);
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: 12px;
      margin-bottom: 8px;
    }
    #line{
      font-size: 16px;
      line-height: 1.5;
      color: var(--text);
    }

    #choices{
      position:absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 148px;
      width: min(920px, 92%);
      display:none;
      flex-direction:column;
      gap: 10px;
      z-index: 6;
    }
    .choice{
      background: rgba(0,0,0,0.82);
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--text);
      padding: 12px 14px;
      cursor:pointer;
      transition: 150ms ease;
      font-size: 14px;
      text-align:left;
    }
    .choice:hover{
      background: rgba(0,240,255,0.12);
      border-color: rgba(0,240,255,0.30);
    }
    .choice small{
      display:block;
      color: var(--muted);
      margin-top: 4px;
      font-size: 12px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    /* Right: controls */
    .btnGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .btn{
      background: linear-gradient(to bottom, var(--btn), var(--btn2));
      border: 1px solid rgba(0,240,255,0.20);
      color: var(--cyan);
      padding: 12px 10px;
      cursor:pointer;
      font-family: inherit;
      letter-spacing: 1px;
      text-transform: uppercase;
      font-size: 12px;
      transition: 140ms ease;
      position: relative;
      overflow:hidden;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 0 22px rgba(0,240,255,0.14);
      border-color: rgba(0,240,255,0.35);
    }
    .btn:active{
      transform: translateY(0);
      filter: brightness(1.15);
    }
    .btn:disabled{
      opacity: 0.35;
      cursor: not-allowed;
      transform: none;
      box-shadow:none;
    }
    .btn.danger{
      border-color: rgba(255,0,60,0.35);
      color: var(--red);
    }
    .btn.danger:hover{
      box-shadow: 0 0 26px rgba(255,0,60,0.18);
      border-color: rgba(255,0,60,0.55);
    }

    .miniNote{
      font-size: 11px;
      color: var(--muted);
      line-height: 1.4;
      border: 1px dashed rgba(255,255,255,0.12);
      padding: 10px;
      background: rgba(0,0,0,0.22);
    }

    .inv{
      display:grid;
      gap: 8px;
    }
    .invRow{
      display:flex; justify-content:space-between;
      font-size: 12px; color: var(--muted);
      padding: 8px 10px;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.25);
    }
    .invRow b{ color: var(--text); font-weight: 700; }

    /* Footer log */
    #log{
      z-index: 5;
      background: #000;
      border-top: 1px solid rgba(255,255,255,0.08);
      padding: 10px 14px;
      overflow:auto;
      font-size: 12px;
      color: #9aa6ad;
      display:flex;
      flex-direction:column;
      gap: 6px;
    }
    .entry{
      border-left: 3px solid rgba(255,255,255,0.12);
      padding-left: 10px;
      line-height: 1.3;
    }
    .entry.ok{ border-left-color: rgba(0,255,65,0.55); color: rgba(0,255,65,0.90); }
    .entry.warn{ border-left-color: rgba(252,238,10,0.65); color: rgba(252,238,10,0.92); }
    .entry.crit{ border-left-color: rgba(255,0,60,0.65); color: rgba(255,0,60,0.94); }
    .entry.sys{ border-left-color: rgba(0,240,255,0.45); color: rgba(0,240,255,0.88); }
    .entry.void{ border-left-color: rgba(157,0,255,0.55); color: rgba(157,0,255,0.92); }

    /* Modal */
    #modalWrap{
      position: fixed; inset:0;
      background: rgba(0,0,0,0.78);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 50;
      padding: 16px;
    }
    .modal{
      width: min(980px, 96vw);
      border: 1px solid rgba(0,240,255,0.25);
      background: rgba(2, 12, 18, 0.96);
      box-shadow: 0 0 60px rgba(0,240,255,0.12);
      padding: 16px;
    }
    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      padding-bottom: 10px;
      margin-bottom: 12px;
      gap: 10px;
    }
    .modalTop h3{
      color: var(--cyan);
      letter-spacing: 2px;
      text-transform: uppercase;
      font-size: 13px;
    }
    .modalTop .hint{
      color: var(--muted);
      font-size: 12px;
      letter-spacing: 1px;
      text-transform: uppercase;
      text-align:right;
      line-height:1.2;
    }
    .modalBody{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 12px;
    }
    .card{
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.25);
      padding: 12px;
      min-height: 0;
    }
    .cardTitle{
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 10px;
    }
    .kbd{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.35);
      padding: 2px 6px;
      color: var(--text);
    }
    .modalBtns{
      display:flex;
      gap: 10px;
      margin-top: 12px;
      justify-content:flex-end;
    }

    .row{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:center;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.20);
      margin-bottom: 10px;
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    input[type="range"]{ width: 100%; }

    .monoBig{
      font-size: 18px;
      color: var(--text);
      letter-spacing: 2px;
    }

    .qte{
      display:grid;
      gap: 10px;
    }
    .qteLine{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 10px;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.20);
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    @media (max-width: 1050px){
      body{ grid-template-rows: 64px 1fr 240px; }
      #main{ grid-template-columns: 1fr; }
      #choices{ bottom: 170px; }
    }
  </style>
</head>
<body>

<header>
  <div class="title">
    <div class="h1">SINTECH // FASE 06</div>
    <div class="sub">PROTOCOLO: DESPERTAR BIOM√âTRICO :: HARDMODE</div>
  </div>

  <div class="hud">
    <div class="pill">
      TEMPO: <b id="tText">06:00</b><br/>
      ESTADO: <b class="v" id="stateText">FLATLINE</b>
    </div>
    <div class="pill">
      ROTA: <b id="routeText">PERFEITA</b><br/>
      FALHAS: <b id="failText">0</b>/3
    </div>
    <div class="pill">
      COER√äNCIA: <b class="v" id="cohText">100</b>%<br/>
      ALARME: <b id="alarmText">N√ÉO</b>
    </div>
  </div>
</header>

<section id="main">
  <!-- LEFT -->
  <aside class="panel">
    <div class="panelTitle">
      <h2>Monitor Biom√©trico</h2>
      <div class="tag">Janelas Din√¢micas</div>
    </div>

    <div class="statRow">
      <span class="k">BPM</span>
      <span class="val crit" id="bpmV">0</span>
    </div>
    <div class="statRow">
      <span class="k">SpO‚ÇÇ</span>
      <span class="val crit" id="spoV">0%</span>
    </div>
    <div class="statRow">
      <span class="k">Temp</span>
      <span class="val warn" id="tmpV">--.-¬∞C</span>
    </div>
    <div class="statRow">
      <span class="k">Arritmia</span>
      <span class="val warn" id="arrV">0%</span>
    </div>

    <div class="bars">
      <div class="barBlock">
        <div class="barHeader"><span>Estresse</span><span id="stressT">0%</span></div>
        <div class="bar"><div class="fill" id="stressF" style="background: var(--yellow)"></div></div>
      </div>

      <div class="barBlock">
        <div class="barHeader"><span>Integridade Neural</span><span id="neuralT">0%</span></div>
        <div class="bar"><div class="fill" id="neuralF" style="background: var(--cyan)"></div></div>
      </div>

      <div class="barBlock">
        <div class="barHeader"><span>Estabilidade de Consci√™ncia</span><span id="mindT">0%</span></div>
        <div class="bar"><div class="fill" id="mindF" style="background: var(--green)"></div></div>
      </div>
    </div>

    <div class="graphs">
      <div class="graphBox">
        <div class="graphLabel">ECG</div>
        <canvas id="ecg"></canvas>
      </div>
      <div class="graphBox">
        <div class="graphLabel">EEG</div>
        <canvas id="eeg"></canvas>
      </div>
    </div>
  </aside>

  <!-- CENTER -->
  <main id="center">
    <div id="camera">
      <div id="silhouette">
        <div class="eye l"></div>
        <div class="eye r"></div>
      </div>
    </div>

    <div id="choices"></div>

    <div id="dialogue">
      <div id="speaker">SISTEMA:</div>
      <div id="line">Hospedeiro inerte. Sem batimentos. Sem satura√ß√£o. Iniciar ressuscita√ß√£o.</div>
    </div>
  </main>

  <!-- RIGHT -->
  <aside class="panel">
    <div class="panelTitle">
      <h2>Suporte √† Vida</h2>
      <div class="tag">Doses + Cooldown</div>
    </div>

    <div class="btnGrid">
      <button class="btn danger" id="defib">‚ö° Defibrilar (300J)</button>
      <button class="btn danger" id="shockLow" disabled>‚ö° Choque Baixo (80J)</button>

      <button class="btn" id="epi" disabled>üíâ Epinefrina</button>
      <button class="btn" id="atrop" disabled>üíâ Atropina</button>

      <button class="btn" id="sed" disabled>üíä Sedativo</button>
      <button class="btn" id="analg" disabled>üíä Analg√©sico</button>

      <button class="btn" id="oxy" disabled>ü´Å Oxig√™nio +</button>
      <button class="btn" id="vent" disabled>ü´Å Ventilar (Manual)</button>

      <button class="btn" id="warm" disabled>üî• Aquecer</button>
      <button class="btn" id="cool" disabled>‚ùÑ Resfriar</button>
    </div>

    <div class="miniNote">
      Regras (hard):
      <br>- Janelas de BPM/SpO‚ÇÇ/Temp mudam.
      <br>- Arritmia pode explodir em p√¢nico.
      <br>- Doses s√£o limitadas; cooldown √© r√≠gido.
      <br>- 3 falhas encerram a rota perfeita.
    </div>

    <div class="panelTitle" style="margin-top:6px;">
      <h2>Calibra√ß√µes</h2>
      <div class="tag">Obrigat√≥rias</div>
    </div>

    <div class="btnGrid">
      <button class="btn" id="calOpt" disabled>üëÅ √ìtica</button>
      <button class="btn" id="calMot" disabled>üß† Motora</button>
      <button class="btn" id="calVoc" disabled>üó£ Vocal</button>
      <button class="btn" id="stabilize" disabled>üß∑ Travar Drift (8s)</button>
    </div>

    <div class="inv">
      <div class="invRow"><span>Epinefrina</span><b id="epiN">2</b></div>
      <div class="invRow"><span>Atropina</span><b id="atrN">2</b></div>
      <div class="invRow"><span>Sedativo</span><b id="sedN">2</b></div>
      <div class="invRow"><span>Analg√©sico</span><b id="anaN">2</b></div>
      <div class="invRow"><span>Oxig√™nio Boost</span><b id="oxyN">3</b></div>
      <div class="invRow"><span>Choque Baixo</span><b id="shkN">2</b></div>
    </div>
  </aside>
</section>

<footer id="log"></footer>

<!-- MODAL -->
<div id="modalWrap">
  <div class="modal">
    <div class="modalTop">
      <h3 id="modalTitle">CALIBRA√á√ÉO</h3>
      <div class="hint" id="modalHint">‚Äî</div>
    </div>

    <div class="modalBody">
      <div class="card">
        <div class="cardTitle" id="leftTitle">INTERFACE</div>
        <div id="modalLeft"></div>
      </div>

      <div class="card">
        <div class="cardTitle" id="rightTitle">DIAGN√ìSTICO</div>
        <div id="modalRight"></div>
      </div>
    </div>

    <div class="modalBtns">
      <button class="btn" id="modalCancel">Cancelar</button>
      <button class="btn" id="modalConfirm">Confirmar</button>
    </div>
  </div>
</div>

<script>
/* ===========================
   SINTECH 6 (Hardmode)
   =========================== */

const $ = (id)=>document.getElementById(id);

const ui = {
  tText: $('tText'),
  stateText: $('stateText'),
  routeText: $('routeText'),
  failText: $('failText'),
  cohText: $('cohText'),
  alarmText: $('alarmText'),

  bpmV: $('bpmV'),
  spoV: $('spoV'),
  tmpV: $('tmpV'),
  arrV: $('arrV'),

  stressT: $('stressT'),
  stressF: $('stressF'),
  neuralT: $('neuralT'),
  neuralF: $('neuralF'),
  mindT: $('mindT'),
  mindF: $('mindF'),

  speaker: $('speaker'),
  line: $('line'),
  choices: $('choices'),

  silhouette: $('silhouette'),
  camera: $('camera'),
  eyes: document.querySelectorAll('.eye'),

  log: $('log'),

  // inventory
  epiN: $('epiN'), atrN: $('atrN'), sedN: $('sedN'), anaN: $('anaN'), oxyN: $('oxyN'), shkN: $('shkN'),

  // controls
  defib: $('defib'),
  shockLow: $('shockLow'),
  epi: $('epi'),
  atrop: $('atrop'),
  sed: $('sed'),
  analg: $('analg'),
  oxy: $('oxy'),
  vent: $('vent'),
  warm: $('warm'),
  cool: $('cool'),

  calOpt: $('calOpt'),
  calMot: $('calMot'),
  calVoc: $('calVoc'),
  stabilize: $('stabilize'),

  modalWrap: $('modalWrap'),
  modalTitle: $('modalTitle'),
  modalHint: $('modalHint'),
  leftTitle: $('leftTitle'),
  rightTitle: $('rightTitle'),
  modalLeft: $('modalLeft'),
  modalRight: $('modalRight'),
  modalCancel: $('modalCancel'),
  modalConfirm: $('modalConfirm')
};

// Simple audio (beeps)
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq=750, type='sine', dur=0.08, vol=0.05){
  try{
    if(audioCtx.state==='suspended') audioCtx.resume();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.setValueAtTime(freq, audioCtx.currentTime);
    g.gain.setValueAtTime(vol, audioCtx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + dur);
  }catch(e){}
}
function alarm(){
  beep(220,'square',0.12,0.08);
  setTimeout(()=>beep(220,'square',0.12,0.08), 140);
  setTimeout(()=>beep(220,'square',0.12,0.08), 280);
}

// Game state
const G = {
  running: true,
  state: 'flatline', // flatline, unstable, waking, stable, complete
  t: 360,            // seconds
  failures: 0,       // max 3
  coherence: 100,    // must stay >= 70 for "rota perfeita"
  alarmOn: false,

  // vitals
  bpm: 0,
  spo2: 0,
  temp: 34.2,
  stress: 0,
  neural: 0,
  mind: 0,
  arr: 0,            // arrhythmia risk %

  // dynamic target ranges
  target: {
    bpmMin: 60, bpmMax: 90,
    spoMin: 93,
    tMin: 35.6, tMax: 37.8,
    stressMax: 78
  },

  // cooldowns
  cd: {
    epi: 0, atrop:0, sed:0, analg:0, oxy:0, vent:0, warm:0, cool:0, shock:0, stabilize:0
  },

  // doses
  inv: {
    epi: 2, atrop:2, sed:2, analg:2, oxy:3, shock:2
  },

  // calibrations
  cal: {
    optic: false,
    motor: false,
    vocal: false
  },

  // narrative
  dialogueIndex: 0,
  lockChoices: false,

  // drift lock
  driftLockedFor: 0,

  // internal flags
  seen: {
    firstBreath:false,
    eyesOnline:false,
    voiceOnline:false,
    hordaMention:false
  }
};

function pushLog(msg, cls='sys'){
  const div = document.createElement('div');
  div.className = `entry ${cls}`;
  div.textContent = msg;
  ui.log.appendChild(div);
  ui.log.scrollTop = ui.log.scrollHeight;
}

function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

function setAlarm(on){
  G.alarmOn = on;
  ui.alarmText.textContent = on ? 'SIM' : 'N√ÉO';
  if(on) alarm();
}

function updateHeader(){
  const mm = String(Math.floor(G.t/60)).padStart(2,'0');
  const ss = String(G.t%60).padStart(2,'0');
  ui.tText.textContent = `${mm}:${ss}`;
  ui.stateText.textContent = G.state.toUpperCase();
  ui.failText.textContent = `${G.failures}`;
  ui.cohText.textContent = `${Math.floor(G.coherence)}`;
  ui.routeText.textContent = (G.coherence >= 70 && G.failures === 0) ? 'PERFEITA' : (G.failures < 3 ? 'COMPROMETIDA' : 'FALHA');
}

function gradeVal(kind, v){
  // simple grade for UI color
  if(kind === 'bpm'){
    if(v === 0) return 'crit';
    if(v < G.target.bpmMin-8 || v > G.target.bpmMax+15) return 'crit';
    if(v < G.target.bpmMin || v > G.target.bpmMax) return 'warn';
    return 'ok';
  }
  if(kind === 'spo'){
    if(v < 85) return 'crit';
    if(v < G.target.spoMin) return 'warn';
    return 'ok';
  }
  if(kind === 'temp'){
    if(v < 35.0 || v > 38.6) return 'crit';
    if(v < G.target.tMin || v > G.target.tMax) return 'warn';
    return 'ok';
  }
  if(kind === 'arr'){
    if(v > 80) return 'crit';
    if(v > 45) return 'warn';
    return 'ok';
  }
  return 'warn';
}

function updateUI(){
  ui.bpmV.textContent = Math.floor(G.bpm);
  ui.spoV.textContent = `${Math.floor(G.spo2)}%`;
  ui.tmpV.textContent = `${G.temp.toFixed(1)}¬∞C`;
  ui.arrV.textContent = `${Math.floor(G.arr)}%`;

  ui.bpmV.className = `val ${gradeVal('bpm', G.bpm)}`;
  ui.spoV.className = `val ${gradeVal('spo', G.spo2)}`;
  ui.tmpV.className = `val ${gradeVal('temp', G.temp)}`;
  ui.arrV.className = `val ${gradeVal('arr', G.arr)}`;

  ui.stressT.textContent = `${Math.floor(G.stress)}%`;
  ui.stressF.style.width = `${clamp(G.stress,0,100)}%`;

  ui.neuralT.textContent = `${Math.floor(G.neural)}%`;
  ui.neuralF.style.width = `${clamp(G.neural,0,100)}%`;

  ui.mindT.textContent = `${Math.floor(G.mind)}%`;
  ui.mindF.style.width = `${clamp(G.mind,0,100)}%`;

  // enable/disable buttons by state
  const alive = G.bpm > 0 && G.spo2 > 0;
  ui.shockLow.disabled = !(alive && G.inv.shock > 0 && G.cd.shock <= 0);
  ui.epi.disabled = !(alive && G.inv.epi > 0 && G.cd.epi <= 0);
  ui.atrop.disabled = !(alive && G.inv.atrop > 0 && G.cd.atrop <= 0);
  ui.sed.disabled = !(alive && G.inv.sed > 0 && G.cd.sed <= 0);
  ui.analg.disabled = !(alive && G.inv.analg > 0 && G.cd.analg <= 0);
  ui.oxy.disabled = !(alive && G.inv.oxy > 0 && G.cd.oxy <= 0);
  ui.vent.disabled = !(alive && G.cd.vent <= 0);
  ui.warm.disabled = !(alive && G.cd.warm <= 0);
  ui.cool.disabled = !(alive && G.cd.cool <= 0);

  // calibrations require thresholds + stability
  const stableWindow = isStableNow();
  ui.calOpt.disabled = !(alive && stableWindow && G.neural >= 25 && !G.cal.optic);
  ui.calMot.disabled = !(alive && stableWindow && G.neural >= 55 && !G.cal.motor);
  ui.calVoc.disabled = !(alive && stableWindow && G.neural >= 75 && !G.cal.vocal);

  ui.stabilize.disabled = !(alive && G.cd.stabilize <= 0);

  // inventory text
  ui.epiN.textContent = G.inv.epi;
  ui.atrN.textContent = G.inv.atrop;
  ui.sedN.textContent = G.inv.sed;
  ui.anaN.textContent = G.inv.analg;
  ui.oxyN.textContent = G.inv.oxy;
  ui.shkN.textContent = G.inv.shock;
}

function fail(reason){
  G.failures += 1;
  setAlarm(true);
  pushLog(`FALHA: ${reason}`, 'crit');
  G.coherence -= 10;
  if(G.failures >= 3){
    hardGameOver(`Falha acumulada: ${reason}`);
  } else {
    // penalty spike
    G.stress = clamp(G.stress + 12, 0, 100);
    G.arr = clamp(G.arr + 18, 0, 100);
  }
}

function hardGameOver(reason){
  G.running = false;
  setAlarm(true);
  beep(160,'sawtooth',0.6,0.1);
  setTimeout(()=>beep(110,'square',0.8,0.08), 200);

  document.body.innerHTML = `
    <div style="height:100vh; display:flex; align-items:center; justify-content:center; background:#000; color:#ff003c; font-family:'Share Tech Mono', monospace; padding:20px; text-align:center;">
      <div style="max-width:900px;">
        <h1 style="letter-spacing:4px; margin-bottom:10px;">FALHA CR√çTICA</h1>
        <p style="color:#ffd1da; margin-bottom:18px;">${escapeHtml(reason)}</p>
        <p style="color:#889; margin-bottom:22px;">A entidade n√£o estabilizou no corpo. A linha se fecha.</p>
        <button onclick="location.reload()" style="padding:12px 18px; background:transparent; color:#fff; border:1px solid #fff; cursor:pointer; font-family:inherit;">
          REINICIAR FASE 06
        </button>
      </div>
    </div>
  `;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
  }[m]));
}

function isStableNow(){
  const bpmOk = G.bpm >= G.target.bpmMin && G.bpm <= G.target.bpmMax;
  const spoOk = G.spo2 >= G.target.spoMin;
  const tOk = G.temp >= G.target.tMin && G.temp <= G.target.tMax;
  const stressOk = G.stress <= G.target.stressMax;
  const arrOk = G.arr <= 45;
  return bpmOk && spoOk && tOk && stressOk && arrOk;
}

// Dynamic ranges drift
function driftTargets(){
  if(G.driftLockedFor > 0) return;

  // random walk with bounds
  const wobble = ()=> (Math.random()-0.5);

  G.target.bpmMin = clamp(G.target.bpmMin + wobble()*2.2, 54, 72);
  G.target.bpmMax = clamp(G.target.bpmMax + wobble()*2.2, 82, 108);

  // keep min<max
  if(G.target.bpmMin > G.target.bpmMax-12) G.target.bpmMin = G.target.bpmMax-12;

  G.target.spoMin = clamp(G.target.spoMin + wobble()*1.2, 91, 96);

  G.target.tMin = clamp(G.target.tMin + wobble()*0.12, 35.4, 36.4);
  G.target.tMax = clamp(G.target.tMax + wobble()*0.12, 37.3, 38.1);
  if(G.target.tMin > G.target.tMax-1.0) G.target.tMin = G.target.tMax-1.0;

  G.target.stressMax = clamp(G.target.stressMax + wobble()*2.0, 68, 84);
}

// Vitals update loop (hard)
function tickVitals(){
  if(!G.running) return;

  // cooldown tick
  for(const k of Object.keys(G.cd)){
    G.cd[k] = Math.max(0, G.cd[k] - 1);
  }
  if(G.driftLockedFor > 0) G.driftLockedFor--;

  // state evolution
  if(G.state === 'flatline'){
    // decay to death-ish (still 0)
    G.bpm = 0; G.spo2 = 0;
    G.temp = clamp(G.temp - 0.01, 33.0, 39.5);
    G.stress = 0;
    G.arr = 0;
    G.neural = 0;
    G.mind = 0;
  } else {
    // baseline drift
    // cold environment tends to drop temp
    G.temp += (Math.random()-0.55) * 0.03; // slight downward bias

    // arrhythmia influenced by stress + bpm extremes
    const bpmOut = Math.max(0, Math.abs(G.bpm - 78) - 18);
    G.arr += (G.stress/100)*0.22 + (bpmOut/100)*0.6 + (Math.random()-0.5)*0.35;
    G.arr = clamp(G.arr, 0, 100);

    // SpO2 decay if no oxygen actions + high arr/stress
    const spoDecay = 0.10 + (G.arr/100)*0.22 + (G.stress/100)*0.16;
    G.spo2 -= spoDecay;

    // BPM drift based on stress + meds residual
    const bpmDrift = (Math.random()-0.5)*1.2 + (G.stress/100)*0.45;
    G.bpm += bpmDrift;

    // Stress tends to rise if unstable
    const unstable = !isStableNow();
    G.stress += unstable ? 0.45 : -0.18;
    G.stress = clamp(G.stress, 0, 100);

    // Neural growth requires stable windows + progress gating
    if(isStableNow()){
      G.neural += 0.55;
      G.mind += 0.45;
      G.coherence += 0.05; // tiny reward
    } else {
      // punish slowly, but arritmia punishes more
      G.neural -= 0.20 + (G.arr/100)*0.15;
      G.mind -= 0.25 + (G.stress/100)*0.12;
      G.coherence -= 0.08 + (G.stress/100)*0.10;
    }

    G.neural = clamp(G.neural, 0, 100);
    G.mind = clamp(G.mind, 0, 100);
    G.coherence = clamp(G.coherence, 0, 100);

    // keep vitals within plausible
    G.temp = clamp(G.temp, 33.0, 39.5);
    G.bpm = clamp(G.bpm, 0, 220);
    G.spo2 = clamp(G.spo2, 0, 100);

    // event: arrhythmia episode
    if(G.arr > 70 && Math.random() < 0.12){
      pushLog("EVENTO: ARRITMIA ESPONT√ÇNEA (RUN) DETECTADA", 'crit');
      beep(120,'square',0.14,0.08);
      // major instability spike
      G.bpm += 18 + Math.random()*12;
      G.spo2 -= 4 + Math.random()*3;
      G.stress = clamp(G.stress + 10, 0, 100);
      setAlarm(true);
    }

    // event: hypoxia
    if(G.spo2 < 86 && Math.random() < 0.18){
      pushLog("EVENTO: HIPOXIA PROFUNDA. COER√äNCIA CAINDO.", 'crit');
      G.coherence -= 2.2;
      setAlarm(true);
    }

    // fail conditions (hard)
    if(G.bpm <= 0){
      fail("Assistolia. Necess√°rio choque.");
      G.state = 'flatline';
    }
    if(G.spo2 <= 0){
      fail("An√≥xia. Satura√ß√£o zerada.");
      G.state = 'flatline';
    }
    if(G.temp < 34.0){
      fail("Hipotermia cr√≠tica.");
    }
    if(G.temp > 39.0){
      fail("Hipertermia cr√≠tica.");
    }
    if(G.stress >= 100){
      fail("Colapso por estresse sist√™mico.");
    }
    if(G.coherence < 45){
      fail("Coer√™ncia de consci√™ncia colapsou.");
    }

    // unlock visuals gradually
    if(G.neural >= 25 && !G.seen.eyesOnline){
      G.seen.eyesOnline = true;
      ui.silhouette.style.opacity = 1;
      ui.silhouette.style.transform = 'scale(1)';
      ui.camera.style.filter = "blur(10px) grayscale(70%) brightness(0.95)";
      pushLog("DESBLOQUEIO: retina sint√©tica responde a est√≠mulo.", 'sys');
      blinkEyes();
    }
    if(G.neural >= 70 && !G.seen.voiceOnline){
      G.seen.voiceOnline = true;
      pushLog("DESBLOQUEIO: sintetizador vocal dispon√≠vel sob estabilidade.", 'sys');
    }

    // narrative triggers
    maybeAdvanceDialogue();
  }

  // alarm toggle
  setAlarm(!isStableNow() && G.state !== 'flatline');

  updateHeader();
  updateUI();
}

// Timer tick
function tickTimer(){
  if(!G.running) return;
  if(G.t <= 0){
    // success only if all calibrations done + thresholds
    if(G.cal.optic && G.cal.motor && G.cal.vocal && G.neural >= 92 && G.mind >= 92 && G.coherence >= 70){
      win();
    } else {
      hardGameOver("Tempo esgotado antes da estabiliza√ß√£o completa.");
    }
    return;
  }
  G.t -= 1;
  updateHeader();

  // drift targets every few seconds (hard)
  if(G.t % 4 === 0) driftTargets();
}

// Dialogue system: always 6 choices
const script = [
  {
    when: ()=> G.state !== 'flatline' && G.neural >= 18 && G.dialogueIndex === 0,
    speaker: "SISTEMA",
    line: "Sinais m√≠nimos detectados. Se estabilizar agora, a entidade vai ouvir. Escolha a primeira instru√ß√£o.",
    choices: [
      { t:"Protocolo de ancoragem: respira√ß√£o guiada e foco auditivo.", note:"Reduz estresse, melhora coer√™ncia.", fx:()=>{G.stress-=6; G.coherence+=3; nextDlg();} , good:true},
      { t:"Sil√™ncio total. N√£o provoque forma√ß√£o de mem√≥ria.", note:"Corta progresso neural.", fx:()=>{G.neural-=6; G.mind-=6; G.coherence-=4; nextDlg();} },
      { t:"Ative ventila√ß√£o agressiva e aumente BPM.", note:"Arrisca arritmia.", fx:()=>{G.bpm+=10; G.arr+=10; G.stress+=6; nextDlg();} },
      { t:"Informe que Marcus e Watcher foram apagados.", note:"Trauma imediato.", fx:()=>{G.stress+=12; G.coherence-=10; nextDlg();} },
      { t:"Minta: 'Voc√™ est√° em casa. Tudo terminou'.", note:"Risco de quebra cognitiva.", fx:()=>{G.mind-=8; G.coherence-=6; nextDlg();} },
      { t:"Provoque: 'Voc√™ n√£o √© real'.", note:"Explode estresse.", fx:()=>{G.stress+=18; G.arr+=12; G.coherence-=12; nextDlg();} }
    ]
  },
  {
    when: ()=> G.neural >= 30 && G.dialogueIndex === 1 && G.cal.optic,
    speaker: "VOID-WALKER",
    line: "Eu‚Ä¶ sinto peso. N√£o era assim. O que eu sou agora?",
    choices: [
      { t:"Voc√™ est√° em um hospedeiro. Corpo novo. Mesmo n√∫cleo.", note:"Aumenta coer√™ncia sem revelar tudo.", fx:()=>{G.coherence+=5; G.mind+=4; nextDlg();}, good:true },
      { t:"Voc√™ foi 'consertado'. N√£o pergunte.", note:"Aumenta stress.", fx:()=>{G.stress+=9; G.coherence-=5; nextDlg();} },
      { t:"Voc√™ foi copiado. O original ficou para tr√°s.", note:"Dissocia.", fx:()=>{G.mind-=7; G.coherence-=7; nextDlg();} },
      { t:"Voc√™ √© um erro √∫til.", note:"Raiva + arritmia.", fx:()=>{G.stress+=13; G.arr+=9; nextDlg();} },
      { t:"Sem respostas. Prioridade √© obedecer.", note:"Ganha controle, perde mente.", fx:()=>{G.mind-=5; G.coherence-=4; nextDlg();} },
      { t:"Voc√™ √© uma porta. E est√° abrindo.", note:"Dispara p√¢nico.", fx:()=>{G.stress+=16; G.arr+=12; nextDlg();} }
    ]
  },
  {
    when: ()=> G.neural >= 55 && G.dialogueIndex === 2 && G.cal.motor,
    speaker: "VOID-WALKER",
    line: "H√° ru√≠do onde devia haver sil√™ncio. Tr√™s batimentos‚Ä¶ mas s√≥ um peito.",
    choices: [
      { t:"Integra√ß√£o parcial. N√£o force lembran√ßas agora.", note:"Mant√©m rota segura.", fx:()=>{G.stress-=6; G.coherence+=5; nextDlg();}, good:true },
      { t:"Ignore o ru√≠do. Isso n√£o importa.", note:"Perde mente.", fx:()=>{G.mind-=8; G.coherence-=5; nextDlg();} },
      { t:"√â Marcus discutindo com Watcher. Voc√™ √© o quarto.", note:"Confunde propositalmente.", fx:()=>{G.stress+=10; G.arr+=7; nextDlg();} },
      { t:"Voc√™ n√£o est√° sozinho dentro de voc√™.", note:"Aumenta medo.", fx:()=>{G.stress+=11; nextDlg();} },
      { t:"Foque no pulso. Conte: 1‚Ä¶2‚Ä¶3‚Ä¶", note:"Ajuda BPM.", fx:()=>{G.bpm=clamp(G.bpm-6,0,220); G.stress-=4; nextDlg();} },
      { t:"Pergunte ao ru√≠do o que ele quer.", note:"Risco de abertura.", fx:()=>{G.coherence-=12; G.mind-=10; nextDlg();} }
    ]
  },
  {
    when: ()=> G.neural >= 78 && G.dialogueIndex === 3 && G.cal.vocal,
    speaker: "VOID-WALKER",
    line: "Se eu falar‚Ä¶ isso vai me dividir? Ou vai me fixar?",
    choices: [
      { t:"Falar fixa. Palavras s√£o √¢ncoras.", note:"Aumenta estabilidade.", fx:()=>{G.mind+=6; G.coherence+=6; nextDlg();}, good:true },
      { t:"Falar √© perigoso. Calado voc√™ sobrevive.", note:"Reduz progresso.", fx:()=>{G.mind-=6; nextDlg();} },
      { t:"Falar libera o que est√° preso.", note:"Aumenta arr.", fx:()=>{G.arr+=10; G.stress+=8; nextDlg();} },
      { t:"Voc√™ n√£o tem permiss√£o para falar.", note:"Trauma.", fx:()=>{G.stress+=12; G.coherence-=7; nextDlg();} },
      { t:"Falar √© um teste. Se falhar, voc√™ apaga.", note:"P√¢nico.", fx:()=>{G.stress+=15; G.arr+=8; nextDlg();} },
      { t:"Diga seu nome real. Agora.", note:"Choque cognitivo.", fx:()=>{G.coherence-=10; G.mind-=8; nextDlg();} }
    ]
  }
];

function nextDlg(){
  G.dialogueIndex++;
  ui.choices.style.display = 'none';
  G.lockChoices = false;
  // minor reward if stable
  if(isStableNow()){
    G.neural = clamp(G.neural + 1.8, 0, 100);
    G.mind = clamp(G.mind + 1.2, 0, 100);
  }else{
    G.coherence = clamp(G.coherence - 1.2, 0, 100);
  }
}

function setDialogue(speaker, line){
  ui.speaker.textContent = `${speaker}:`;
  ui.line.textContent = line;
  if(speaker === "VOID-WALKER") blinkEyes();
}

function showChoices(choices){
  ui.choices.innerHTML = '';
  ui.choices.style.display = 'flex';
  G.lockChoices = false;

  choices.forEach((c, i)=>{
    const b = document.createElement('button');
    b.className = 'choice';
    b.innerHTML = `> ${escapeHtml(c.t)}<small>${escapeHtml(c.note || '')}</small>`;
    b.onclick = ()=>{
      if(G.lockChoices) return;
      G.lockChoices = true;
      // choice impact
      c.fx();
      if(c.good) pushLog("Resposta: ancoragem bem-sucedida.", "ok");
      else pushLog("Resposta: interfer√™ncia cognitiva registrada.", "warn");
    };
    ui.choices.appendChild(b);
  });
}

function maybeAdvanceDialogue(){
  if(G.lockChoices) return;

  // only show dialogues if stable enough to "ouvir"
  if(!isStableNow() && G.dialogueIndex > 0) return;

  for(const node of script){
    if(node.when()){
      setDialogue(node.speaker, node.line);
      // each node requires 6 choices
      showChoices(node.choices);
      pushLog("INTERFACE: escolha cr√≠tica dispon√≠vel.", "sys");
      break;
    }
  }

  // final check for win readiness (before timer ends)
  if(G.cal.optic && G.cal.motor && G.cal.vocal && G.neural >= 92 && G.mind >= 92 && G.coherence >= 70){
    // subtle hint
    if(G.t < 60 && Math.random() < 0.15){
      pushLog("SISTEMA: estabiliza√ß√£o quase completa. N√£o perca a janela.", "warn");
    }
  }
}

// Eye blink
function blinkEyes(){
  ui.eyes.forEach(e=>e.classList.add('open'));
  setTimeout(()=> ui.eyes.forEach(e=>e.classList.remove('open')), 220);
  setTimeout(()=> ui.eyes.forEach(e=>e.classList.add('open')), 820);
  setTimeout(()=> ui.eyes.forEach(e=>e.classList.remove('open')), 1020);
}

// Controls actions
function useDose(kind, cdSec){
  if(G.inv[kind] <= 0) return false;
  if(G.cd[kind] > 0) return false;
  G.inv[kind]--;
  G.cd[kind] = cdSec;
  return true;
}

ui.defib.onclick = ()=>{
  if(G.state !== 'flatline'){
    fail("Defibrila√ß√£o aplicada fora de assistolia.");
    return;
  }
  beep(180,'sawtooth',0.55,0.10);
  setTimeout(()=>{
    beep(60,'square',0.22,0.18);
    G.state = 'unstable';
    G.bpm = 46;
    G.spo2 = 78;
    G.temp = 34.5;
    G.stress = 18;
    G.arr = 20;
    pushLog("CHOQUE 300J: ritmo iniciado, satura√ß√£o baixa.", "warn");
    // unlock basic buttons
    pushLog("SISTEMA: suporte √† vida liberado. Mantenha a janela.", "sys");
    setDialogue("SISTEMA","Ritmo inicial fraco. Satura√ß√£o baixa. Aten√ß√£o √†s janelas din√¢micas.");
  }, 900);
};

ui.shockLow.onclick = ()=>{
  if(G.inv.shock <= 0 || G.cd.shock > 0) return;
  if(!useDose('shock', 16)) return;
  beep(75,'square',0.18,0.16);
  pushLog("CHOQUE 80J: tentativa de interromper arritmia.", "sys");
  // effect: reduce arr, but stress spike
  G.arr = clamp(G.arr - (18 + Math.random()*10), 0, 100);
  G.stress = clamp(G.stress + 6, 0, 100);
  // may also drop bpm slightly
  G.bpm = clamp(G.bpm - (4 + Math.random()*4), 0, 220);
};

ui.epi.onclick = ()=>{
  if(!useDose('epi', 22)) return;
  pushLog("EPINEFRINA: +BPM, +Arritmia, +Estresse", "warn");
  beep(920,'sine',0.08,0.05);
  G.bpm = clamp(G.bpm + 16 + Math.random()*6, 0, 220);
  G.arr = clamp(G.arr + 10 + Math.random()*6, 0, 100);
  G.stress = clamp(G.stress + 8, 0, 100);
};

ui.atrop.onclick = ()=>{
  if(!useDose('atrop', 20)) return;
  pushLog("ATROPINA: estabiliza bradicardia e reduz arritmia leve", "sys");
  beep(740,'sine',0.08,0.05);
  if(G.bpm < 60) G.bpm = clamp(G.bpm + 10 + Math.random()*4, 0, 220);
  G.arr = clamp(G.arr - (8 + Math.random()*6), 0, 100);
  G.stress = clamp(G.stress + 3, 0, 100);
};

ui.sed.onclick = ()=>{
  if(!useDose('sed', 24)) return;
  pushLog("SEDATIVO: -Estresse, -BPM (risco hip√≥xia se exagerar)", "sys");
  beep(520,'sine',0.08,0.05);
  G.stress = clamp(G.stress - (18 + Math.random()*8), 0, 100);
  G.arr = clamp(G.arr - (6 + Math.random()*4), 0, 100);
  G.bpm = clamp(G.bpm - (8 + Math.random()*6), 0, 220);
  // mild SpO2 penalty
  G.spo2 = clamp(G.spo2 - (1 + Math.random()*2), 0, 100);
};

ui.analg.onclick = ()=>{
  if(!useDose('analg', 26)) return;
  pushLog("ANALG√âSICO: reduz stress, melhora coer√™ncia.", "ok");
  beep(610,'sine',0.08,0.05);
  G.stress = clamp(G.stress - (12 + Math.random()*6), 0, 100);
  G.coherence = clamp(G.coherence + (3 + Math.random()*2), 0, 100);
  // small arr benefit
  G.arr = clamp(G.arr - (4 + Math.random()*3), 0, 100);
};

ui.oxy.onclick = ()=>{
  if(!useDose('oxy', 18)) return;
  pushLog("OXIG√äNIO BOOST: +SpO‚ÇÇ (curto)", "ok");
  beep(860,'sine',0.08,0.05);
  G.spo2 = clamp(G.spo2 + (10 + Math.random()*7), 0, 100);
  // stress can drop a bit
  G.stress = clamp(G.stress - 3, 0, 100);
};

ui.vent.onclick = ()=>{
  if(G.cd.vent > 0) return;
  G.cd.vent = 8;
  pushLog("VENTILA√á√ÉO MANUAL: +SpO‚ÇÇ moderado, +Estresse se repetido", "sys");
  beep(330,'triangle',0.08,0.04);
  G.spo2 = clamp(G.spo2 + (4 + Math.random()*3), 0, 100);
  G.stress = clamp(G.stress + 2, 0, 100);
};

ui.warm.onclick = ()=>{
  if(G.cd.warm > 0) return;
  G.cd.warm = 12;
  pushLog("AQUECIMENTO: +Temp (lento)", "sys");
  beep(420,'sine',0.08,0.04);
  G.temp = clamp(G.temp + (0.25 + Math.random()*0.18), 33, 39.5);
};

ui.cool.onclick = ()=>{
  if(G.cd.cool > 0) return;
  G.cd.cool = 12;
  pushLog("RESFRIAMENTO: -Temp (lento)", "sys");
  beep(380,'sine',0.08,0.04);
  G.temp = clamp(G.temp - (0.22 + Math.random()*0.18), 33, 39.5);
};

ui.stabilize.onclick = ()=>{
  if(G.cd.stabilize > 0) return;
  G.cd.stabilize = 30;
  G.driftLockedFor = 8;
  pushLog("TRAVA DE DRIFT: janelas congeladas por 8s.", "ok");
  beep(980,'square',0.10,0.05);
};

// ======================
// Calibrations (Modals)
// ======================
let modalMode = null;

function openModal(mode){
  modalMode = mode;
  ui.modalWrap.style.display = 'flex';

  ui.modalLeft.innerHTML = '';
  ui.modalRight.innerHTML = '';
  ui.modalHint.textContent = 'Risco: instabilidade durante calibra√ß√£o.';

  if(mode === 'optic') buildOptic();
  if(mode === 'motor') buildMotor();
  if(mode === 'vocal') buildVocal();
}

function closeModal(){
  ui.modalWrap.style.display = 'none';
  modalMode = null;
}

ui.modalCancel.onclick = ()=>{
  pushLog("CALIBRA√á√ÉO cancelada. Janela desperdi√ßada.", "warn");
  G.coherence = clamp(G.coherence - 2, 0, 100);
  closeModal();
};

ui.calOpt.onclick = ()=> openModal('optic');
ui.calMot.onclick = ()=> openModal('motor');
ui.calVoc.onclick = ()=> openModal('vocal');

let opticTarget = { a: 0, b: 0, c: 0 };
let opticVal = { a: 50, b: 50, c: 50 };
let opticTime = 18;

function buildOptic(){
  ui.modalTitle.textContent = "CALIBRA√á√ÉO √ìTICA";
  ui.leftTitle.textContent = "AJUSTE DE LENTES (3 EIXOS)";
  ui.rightTitle.textContent = "DIAGN√ìSTICO / TOLER√ÇNCIA";

  // hidden target
  opticTarget = {
    a: Math.floor(18 + Math.random()*64),
    b: Math.floor(18 + Math.random()*64),
    c: Math.floor(18 + Math.random()*64),
  };
  opticVal = { a: 50, b: 50, c: 50 };
  opticTime = 18;

  const left = document.createElement('div');
  left.innerHTML = `
    <div class="row"><span>EIXO Œ±</span><span class="monoBig" id="oa">50</span></div>
    <input id="ra" type="range" min="0" max="100" value="50">
    <div class="row"><span>EIXO Œ≤</span><span class="monoBig" id="ob">50</span></div>
    <input id="rb" type="range" min="0" max="100" value="50">
    <div class="row"><span>EIXO Œ≥</span><span class="monoBig" id="oc">50</span></div>
    <input id="rc" type="range" min="0" max="100" value="50">
    <div class="miniNote" style="margin-top:10px;">
      Objetivo: alinhar os 3 eixos com toler√¢ncia de ¬±4 antes do tempo acabar.
      <br>Observa√ß√£o: a janela de estabilidade pode fechar durante o ajuste.
    </div>
  `;
  ui.modalLeft.appendChild(left);

  const right = document.createElement('div');
  right.innerHTML = `
    <div class="qte">
      <div class="qteLine"><span>TEMPO</span><b id="ot">${opticTime}s</b></div>
      <div class="qteLine"><span>ERRO TOTAL</span><b id="oe">--</b></div>
      <div class="qteLine"><span>TOLER√ÇNCIA</span><b>¬±4 (cada eixo)</b></div>
      <div class="qteLine"><span>STATUS</span><b id="os">EM AJUSTE</b></div>
    </div>
    <div class="miniNote" style="margin-top:10px;">
      Dica: use "TRAVA DE DRIFT" antes de iniciar para segurar as janelas.
    </div>
  `;
  ui.modalRight.appendChild(right);

  const ra = $('ra'), rb = $('rb'), rc = $('rc');
  const oa = $('oa'), ob = $('ob'), oc = $('oc');

  const update = ()=>{
    opticVal.a = +ra.value; opticVal.b = +rb.value; opticVal.c = +rc.value;
    oa.textContent = opticVal.a; ob.textContent = opticVal.b; oc.textContent = opticVal.c;
    const ea = Math.abs(opticVal.a - opticTarget.a);
    const eb = Math.abs(opticVal.b - opticTarget.b);
    const ec = Math.abs(opticVal.c - opticTarget.c);
    $('oe').textContent = `${ea+eb+ec}`;
    const ok = (ea<=4 && eb<=4 && ec<=4);
    $('os').textContent = ok ? "ALINHADO" : "DESALINHADO";
    $('os').style.color = ok ? 'var(--green)' : 'var(--yellow)';
  };
  ra.oninput = rb.oninput = rc.oninput = update;
  update();

  // timer
  const int = setInterval(()=>{
    if(modalMode !== 'optic'){ clearInterval(int); return; }
    opticTime--;
    $('ot').textContent = `${opticTime}s`;

    // penalize if unstable mid-cal
    if(!isStableNow()){
      G.stress = clamp(G.stress + 0.8, 0, 100);
      G.arr = clamp(G.arr + 0.6, 0, 100);
    }

    if(opticTime <= 0){
      clearInterval(int);
      // auto fail
      pushLog("CALIBRA√á√ÉO √ìTICA: tempo esgotado.", "crit");
      fail("Falha na calibra√ß√£o √≥tica.");
      closeModal();
    }
  }, 1000);
}

let motorSeq = [];
let motorIndex = 0;
let motorMistakes = 0;
let motorTime = 22;
let motorListening = false;

function buildMotor(){
  ui.modalTitle.textContent = "CALIBRA√á√ÉO MOTORA";
  ui.leftTitle.textContent = "SEQU√äNCIA NEURAL (W A S D)";
  ui.rightTitle.textContent = "DIAGN√ìSTICO / ERROS";

  motorSeq = Array.from({length: 10}, ()=> ['W','A','S','D'][Math.floor(Math.random()*4)]);
  motorIndex = 0;
  motorMistakes = 0;
  motorTime = 22;
  motorListening = true;

  const left = document.createElement('div');
  left.innerHTML = `
    <div class="miniNote">
      Digite a sequ√™ncia exibida, sem atrasar. Voc√™ s√≥ pode errar 2 vezes.
      <br>Teclas: <span class="kbd">W</span> <span class="kbd">A</span> <span class="kbd">S</span> <span class="kbd">D</span>
    </div>
    <div style="margin-top:12px; padding:12px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.20);">
      <div style="font-size:12px; color:var(--muted); letter-spacing:2px; text-transform:uppercase; margin-bottom:8px;">SEQU√äNCIA</div>
      <div class="monoBig" id="mseq" style="white-space:pre-wrap; word-break:break-word;"></div>
    </div>
    <div style="margin-top:12px; padding:12px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.20);">
      <div style="font-size:12px; color:var(--muted); letter-spacing:2px; text-transform:uppercase; margin-bottom:8px;">PROGRESSO</div>
      <div class="monoBig" id="mprog">0/10</div>
    </div>
  `;
  ui.modalLeft.appendChild(left);

  const right = document.createElement('div');
  right.innerHTML = `
    <div class="qte">
      <div class="qteLine"><span>TEMPO</span><b id="mt">${motorTime}s</b></div>
      <div class="qteLine"><span>ERROS</span><b id="mm">${motorMistakes}/2</b></div>
      <div class="qteLine"><span>STATUS</span><b id="ms">AGUARDANDO INPUT</b></div>
    </div>
    <div class="miniNote" style="margin-top:10px;">
      Dica: se o BPM sair da janela durante isso, a arritmia sobe r√°pido.
    </div>
  `;
  ui.modalRight.appendChild(right);

  const render = ()=>{
    // show with caret
    const shown = motorSeq.map((c, i)=>{
      if(i < motorIndex) return `[${c}]`;
      if(i === motorIndex) return `>${c}<`;
      return ` ${c} `;
    }).join(' ');
    $('mseq').textContent = shown;
    $('mprog').textContent = `${motorIndex}/10`;
    $('mm').textContent = `${motorMistakes}/2`;
  };
  render();

  const onKey = (e)=>{
    if(modalMode !== 'motor' || !motorListening) return;
    const k = String(e.key || '').toUpperCase();
    if(!['W','A','S','D'].includes(k)) return;

    // instability penalty for panic typing
    G.stress = clamp(G.stress + 0.5, 0, 100);

    const expected = motorSeq[motorIndex];
    if(k === expected){
      beep(920,'sine',0.05,0.04);
      motorIndex++;
      $('ms').textContent = "OK";
      $('ms').style.color = 'var(--green)';
    } else {
      beep(160,'square',0.08,0.06);
      motorMistakes++;
      $('ms').textContent = "ERRO";
      $('ms').style.color = 'var(--red)';
      G.coherence = clamp(G.coherence - 3.5, 0, 100);
      G.arr = clamp(G.arr + 4.5, 0, 100);
    }

    render();

    if(motorMistakes > 2){
      motorListening = false;
      document.removeEventListener('keydown', onKey);
      pushLog("CALIBRA√á√ÉO MOTORA: erros excedidos.", "crit");
      fail("Falha na calibra√ß√£o motora.");
      closeModal();
      return;
    }

    if(motorIndex >= motorSeq.length){
      motorListening = false;
      document.removeEventListener('keydown', onKey);
      pushLog("CALIBRA√á√ÉO MOTORA: conclu√≠da.", "ok");
      G.cal.motor = true;
      G.coherence = clamp(G.coherence + 6, 0, 100);
      G.mind = clamp(G.mind + 4, 0, 100);
      closeModal();
    }
  };

  document.addEventListener('keydown', onKey);

  const int = setInterval(()=>{
    if(modalMode !== 'motor'){
      clearInterval(int);
      document.removeEventListener('keydown', onKey);
      return;
    }
    motorTime--;
    $('mt').textContent = `${motorTime}s`;

    // being unstable here is brutal
    if(!isStableNow()){
      G.arr = clamp(G.arr + 1.2, 0, 100);
      G.stress = clamp(G.stress + 0.9, 0, 100);
    }

    if(motorTime <= 0){
      clearInterval(int);
      motorListening = false;
      document.removeEventListener('keydown', onKey);
      pushLog("CALIBRA√á√ÉO MOTORA: tempo esgotado.", "crit");
      fail("Falha na calibra√ß√£o motora (tempo).");
      closeModal();
    }
  }, 1000);
}

let vocalSeq = [];
let vocalPick = [];
let vocalTime = 18;

function buildVocal(){
  ui.modalTitle.textContent = "CALIBRA√á√ÉO VOCAL";
  ui.leftTitle.textContent = "FONEMAS / ORDEM";
  ui.rightTitle.textContent = "DIAGN√ìSTICO / CHECKSUM";

  vocalSeq = ["VA","RI","AN","TE"]; // fixed target
  // shuffled options
  const pool = ["VA","RI","AN","TE","XU","NO"];
  // show 6 buttons (hard requirement)
  const opts = pool.sort(()=>Math.random()-0.5);
  vocalPick = [];
  vocalTime = 18;

  const left = document.createElement('div');
  left.innerHTML = `
    <div class="miniNote">
      Monte a frase-base do sintetizador. Se errar, a entidade registra falha de identidade.
      <br>Objetivo (oculto): 4 fonemas corretos na ordem correta.
    </div>

    <div style="margin-top:12px; display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;" id="vBtns"></div>

    <div style="margin-top:12px; padding:12px; border:1px solid rgba(255,255,255,0.06); background:rgba(0,0,0,0.20);">
      <div style="font-size:12px; color:var(--muted); letter-spacing:2px; text-transform:uppercase; margin-bottom:8px;">SELE√á√ÉO</div>
      <div class="monoBig" id="vpick">‚Äî</div>
    </div>
  `;
  ui.modalLeft.appendChild(left);

  const right = document.createElement('div');
  right.innerHTML = `
    <div class="qte">
      <div class="qteLine"><span>TEMPO</span><b id="vt">${vocalTime}s</b></div>
      <div class="qteLine"><span>CHECKSUM</span><b id="vcs">0x00</b></div>
      <div class="qteLine"><span>STATUS</span><b id="vs">INCOMPLETO</b></div>
    </div>
    <div class="miniNote" style="margin-top:10px;">
      Dica: se SpO‚ÇÇ cair durante isso, a fala sai "cortada" e voc√™ perde coer√™ncia.
    </div>
  `;
  ui.modalRight.appendChild(right);

  const vBtns = $('vBtns');
  opts.forEach(token=>{
    const b = document.createElement('button');
    b.className = 'btn';
    b.textContent = token;
    b.onclick = ()=>{
      if(modalMode !== 'vocal') return;
      if(vocalPick.length >= 4) return;

      vocalPick.push(token);
      beep(720,'sine',0.06,0.04);

      // checksum toy: sum charcodes mod 256
      const sum = vocalPick.join('').split('').reduce((a,ch)=>a+ch.charCodeAt(0),0) & 255;
      $('vcs').textContent = '0x' + sum.toString(16).toUpperCase().padStart(2,'0');

      $('vpick').textContent = vocalPick.join(' ¬∑ ');
      $('vs').textContent = `${vocalPick.length}/4`;
      $('vs').style.color = 'var(--yellow)';

      // hypoxia penalty during vocal
      if(G.spo2 < G.target.spoMin){
        G.coherence = clamp(G.coherence - 1.4, 0, 100);
        G.stress = clamp(G.stress + 0.6, 0, 100);
      }

      if(vocalPick.length === 4){
        // confirm result here, but still require modalConfirm to finalize
        $('vs').textContent = 'PRONTO PARA CONFIRMAR';
        $('vs').style.color = 'var(--cyan)';
      }
    };
    vBtns.appendChild(b);
  });

  const int = setInterval(()=>{
    if(modalMode !== 'vocal'){
      clearInterval(int);
      return;
    }
    vocalTime--;
    $('vt').textContent = `${vocalTime}s`;

    if(!isStableNow()){
      G.stress = clamp(G.stress + 0.9, 0, 100);
      G.arr = clamp(G.arr + 0.6, 0, 100);
    }

    if(vocalTime <= 0){
      clearInterval(int);
      pushLog("CALIBRA√á√ÉO VOCAL: tempo esgotado.", "crit");
      fail("Falha na calibra√ß√£o vocal (tempo).");
      closeModal();
    }
  }, 1000);
}

ui.modalConfirm.onclick = ()=>{
  if(!modalMode) return;

  if(modalMode === 'optic'){
    // verify tolerance
    const ea = Math.abs(opticVal.a - opticTarget.a);
    const eb = Math.abs(opticVal.b - opticTarget.b);
    const ec = Math.abs(opticVal.c - opticTarget.c);
    if(ea<=4 && eb<=4 && ec<=4){
      pushLog("CALIBRA√á√ÉO √ìTICA: conclu√≠da.", "ok");
      G.cal.optic = true;
      G.coherence = clamp(G.coherence + 5, 0, 100);
      ui.camera.style.filter = "blur(6px) grayscale(50%) brightness(1.0)";
      closeModal();
    }else{
      pushLog("CALIBRA√á√ÉO √ìTICA: confirma√ß√£o falhou (toler√¢ncia).", "crit");
      fail("Falha na calibra√ß√£o √≥tica (toler√¢ncia).");
      closeModal();
    }
    return;
  }

  if(modalMode === 'motor'){
    // motor is auto-concluded by keys
    pushLog("CALIBRA√á√ÉO MOTORA: confirme ap√≥s concluir a sequ√™ncia.", "warn");
    return;
  }

  if(modalMode === 'vocal'){
    if(vocalPick.length !== 4){
      pushLog("CALIBRA√á√ÉO VOCAL: incompleta.", "warn");
      G.coherence = clamp(G.coherence - 2.5, 0, 100);
      closeModal();
      return;
    }
    const ok = vocalPick.join('-') === vocalSeq.join('-');
    if(ok){
      pushLog("CALIBRA√á√ÉO VOCAL: conclu√≠da. Voz fixa.", "ok");
      G.cal.vocal = true;
      G.mind = clamp(G.mind + 6, 0, 100);
      G.coherence = clamp(G.coherence + 7, 0, 100);
      closeModal();
    }else{
      pushLog("CALIBRA√á√ÉO VOCAL: padr√£o inv√°lido. Identidade inst√°vel.", "crit");
      fail("Falha na calibra√ß√£o vocal (ordem).");
      closeModal();
    }
    return;
  }
};

// ================
// WIN
// ================
function win(){
  G.running = false;
  setAlarm(false);
  beep(440,'sine',0.10,0.06);
  setTimeout(()=>beep(554,'sine',0.10,0.06), 120);
  setTimeout(()=>beep(659,'sine',0.25,0.06), 240);

  const okRoute = (G.failures === 0 && G.coherence >= 70);

  document.body.innerHTML = `
    <div style="height:100vh; display:flex; align-items:center; justify-content:center; background:#000; color:#00f0ff; font-family:'Share Tech Mono', monospace; padding:20px; text-align:center;">
      <div style="max-width:980px;">
        <h1 style="letter-spacing:4px; margin-bottom:10px;">FASE 06 CONCLU√çDA</h1>
        <p style="color:#d7fbff; margin-bottom:12px;">
          Hospedeiro estabilizado. √ìtica, motricidade e voz calibradas. Consci√™ncia ancorada.
        </p>
        <p style="color:${okRoute ? '#00ff41' : '#fcee0a'}; margin-bottom:18px;">
          Rota: ${okRoute ? 'PERFEITA' : 'COMPROMETIDA'} ¬∑ Falhas: ${G.failures}/3 ¬∑ Coer√™ncia: ${Math.floor(G.coherence)}%
        </p>
        <a href="sintech7.html" style="display:inline-block; padding:12px 18px; border:1px solid #fff; color:#fff; text-decoration:none;">
          INICIAR FASE 07
        </a>
      </div>
    </div>
  `;
}

// ======================
// CANVAS: ECG + EEG
// ======================
const ecg = $('ecg'), eeg = $('eeg');
const ecgCtx = ecg.getContext('2d');
const eegCtx = eeg.getContext('2d');
let ecgX = 0, eegX = 0;
let lastBeat = 0;

function resizeCanv(){
  const boxes = [
    {c: ecg, ctx: ecgCtx},
    {c: eeg, ctx: eegCtx}
  ];
  boxes.forEach(b=>{
    b.c.width = b.c.parentElement.clientWidth;
    b.c.height = b.c.parentElement.clientHeight;
    b.ctx.clearRect(0,0,b.c.width,b.c.height);
  });
}
window.addEventListener('resize', resizeCanv);
resizeCanv();

function drawGrid(ctx, w, h){
  ctx.save();
  ctx.strokeStyle = 'rgba(0,240,255,0.06)';
  ctx.lineWidth = 1;
  for(let y=0;y<h;y+=20){
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
  }
  for(let x=0;x<w;x+=20){
    ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
  }
  ctx.restore();
}

function tickGraphs(){
  if(!G.running) return;
  // ECG
  const w = ecg.width, h = ecg.height;
  if(ecgX === 0){
    ecgCtx.clearRect(0,0,w,h);
    drawGrid(ecgCtx,w,h);
  }
  const mid = h*0.55;
  const speed = clamp((G.bpm/60)*2.0, 1.2, 7.0);

  // compute beat interval
  if(G.bpm > 0){
    const now = performance.now();
    const interval = 60000 / clamp(G.bpm, 30, 200);
    if(now - lastBeat > interval){
      lastBeat = now;
      // spike
      ecgCtx.strokeStyle = (isStableNow() ? 'rgba(0,240,255,0.85)' : 'rgba(255,0,60,0.85)');
      ecgCtx.lineWidth = 2;

      const x0 = ecgX;
      const pts = [
        [x0, mid],
        [x0+8, mid-8],
        [x0+16, mid+10],
        [x0+24, mid-55],
        [x0+32, mid+38],
        [x0+40, mid]
      ];
      ecgCtx.beginPath();
      ecgCtx.moveTo(pts[0][0], pts[0][1]);
      for(let i=1;i<pts.length;i++) ecgCtx.lineTo(pts[i][0], pts[i][1]);
      ecgCtx.stroke();
      ecgX += 42;
    } else {
      // baseline noise
      const noise = (Math.random()-0.5) * (2 + (G.arr/100)*10);
      ecgCtx.strokeStyle = (isStableNow() ? 'rgba(0,255,65,0.45)' : 'rgba(252,238,10,0.45)');
      ecgCtx.lineWidth = 2;
      ecgCtx.beginPath();
      ecgCtx.moveTo(ecgX, mid);
      ecgX += speed;
      ecgCtx.lineTo(ecgX, mid + noise);
      ecgCtx.stroke();
    }
  } else {
    // flatline
    ecgCtx.strokeStyle = 'rgba(255,0,60,0.85)';
    ecgCtx.lineWidth = 2;
    ecgCtx.beginPath();
    ecgCtx.moveTo(ecgX, mid);
    ecgX += 2;
    ecgCtx.lineTo(ecgX, mid);
    ecgCtx.stroke();
  }

  if(ecgX > w){
    ecgX = 0;
  }

  // EEG
  const w2 = eeg.width, h2 = eeg.height;
  if(eegX === 0){
    eegCtx.clearRect(0,0,w2,h2);
    drawGrid(eegCtx,w2,h2);
  }
  const mid2 = h2*0.55;
  const amp = 6 + (G.neural/100)*18 + (G.stress/100)*10;
  const freq = 0.03 + (G.mind/100)*0.05 + (G.arr/100)*0.03;
  const y = mid2 + Math.sin(eegX*freq + performance.now()*0.004) * amp + (Math.random()-0.5)*(G.stress/100)*10;

  eegCtx.strokeStyle = (G.neural > 60 ? 'rgba(157,0,255,0.65)' : 'rgba(0,240,255,0.45)');
  eegCtx.lineWidth = 2;
  eegCtx.beginPath();
  eegCtx.moveTo(eegX, y);
  eegX += 2;
  eegCtx.lineTo(eegX, y);
  eegCtx.stroke();

  if(eegX > w2) eegX = 0;

  requestAnimationFrame(tickGraphs);
}

// ======================
// Start loops
// ======================
pushLog("BOOT: protocolos carregados. Aguarde choque inicial.", "sys");
updateHeader();
updateUI();
requestAnimationFrame(tickGraphs);

// fast vitals loop
setInterval(()=>tickVitals(), 250);
// 1s timer loop
setInterval(()=>tickTimer(), 1000);

// Allow click anywhere to unlock audio on browsers
document.addEventListener('click', ()=>{ try{ if(audioCtx.state==='suspended') audioCtx.resume(); }catch(e){} }, { once:true });

</script>
</body>
</html>
